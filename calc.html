<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Mid-Drive Planner v10 ‚Äî Gearing ‚Ä¢ Grades ‚Ä¢ Range ‚Ä¢ Uncertainty ‚Ä¢ Gear Visualizer</title>
<style>
  :root{
    --bg:#070b10;--panel:#0f1622;--ink:#e8eef6;--muted:#a9b7c6;
    --accent:#4da3ff;--accent2:#7dffb0;--warn:#ffb84d;--danger:#ff6b6b;--grid:#233040;
    --glow1:#3ea1ff;--glow2:#80ffcf
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Neon background (static, no panning/animation) */
  body::before{
    content:"";position:fixed;inset:0;pointer-events:none;z-index:-2;opacity:.35;
    background:
      radial-gradient(80vmax 80vmax at 20% 10%, #143055 0%, transparent 55%),
      radial-gradient(80vmax 80vmax at 80% 80%, #0d3a2c 0%, transparent 55%),
      repeating-linear-gradient(0deg, #0b1320 0 2px, #0b1320 2px 20px, #0c1624 20px 40px);
    mix-blend-mode:screen;
  }
  /* Remove scanline overlay entirely */
  body::after{display:none!important}

  header{
    padding:14px 16px;border-bottom:1px solid #182232;
    background:linear-gradient(180deg,#0c121a,#0a0f15);
    position:sticky;top:0;z-index:5
  }
  h1{font-size:18px;margin:0 0 4px 0;
    background:linear-gradient(90deg,#cfe2ff,#b9ffdb);
    -webkit-background-clip:text;background-clip:text;color:transparent
  }
  .sub{color:var(--muted);font-size:12px}
  main{padding:12px;max-width:1200px;margin:0 auto}
  .grid{display:grid;gap:12px}
  @media(min-width:1020px){.grid{grid-template-columns:440px 1fr}}
  .card{
    background:rgba(18,24,33,.88);
    border:1px solid #182232;border-radius:14px;padding:12px;
    box-shadow:0 10px 30px #00000066, inset 0 1px 0 #ffffff08;
    transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease
  }
  .card:hover{transform:translateY(-2px); box-shadow:0 16px 46px #00000080, 0 0 0 1px #3aa1ff20}
  .inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .inputs .full{grid-column:1/-1}
  label{
    font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;margin-bottom:4px
  }
  input,select,button{
    width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #3a4b60;background:#1a2634;
    color:#ffffff;padding:10px 12px;font-size:14px;outline:none;font-weight:500
  }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px #4da3ff22;background:#203040}
  input:hover,select:hover{border-color:#4a5b70;background:#1f2e3f}
  input[disabled],select[disabled]{background:#0f1a25;color:#8a9aa6;border-color:#2a3540;opacity:0.7}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{
    position:relative;background:linear-gradient(180deg,#49a0ff,#2a6fbf);color:#001b33;border:none;font-weight:700;cursor:pointer
  }
  .btn.secondary{background:linear-gradient(180deg,#14202f,#0f1a29);color:var(--ink);border:1px solid #223044}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  /* Kill glossy sideways sheen */
  .btn::after{content:none!important}

  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#162131;border:1px solid #223044;color:var(--ink);font-size:12px;cursor:pointer}
  .section-title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin:4px 0 8px;display:flex;align-items:center;gap:6px}
  
  /* Enhanced section styling */
  .input-section{
    background:rgba(29, 44, 63, 0.6);
    border:1px solid #1a2634;
    border-radius:12px;
    padding:16px;
    margin-bottom:16px;
    position:relative;
    transition:all .25s ease;
  }
  .input-section:hover{
    background:rgba(37, 78, 134, 0.8);
    border-color:#2a3b55;
  }
  .input-section .section-title{
    margin:-4px 0 12px 0;
    font-size:14px;
    font-weight:600;
    color:var(--accent2);
  }
  .section-icon{
    width:18px;
    height:18px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    color:var(--accent);
    background:rgba(77,163,255,.15);
    border-radius:6px;
    flex-shrink:0;
  }
  
  canvas{width:100%;height:260px;border-radius:12px;background:#0b1118;border:1px solid #182232;box-shadow:inset 0 0 0 1px #ffffff08}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:6px 8px;border-bottom:1px solid #1a2634;text-align:right}
  th{color:var(--muted);font-weight:600}
  td:first-child,th:first-child{text-align:left}
  tbody tr.sel{background:linear-gradient(90deg,#0f1622,#0e1f31)}
  tbody tr.sel td{box-shadow:inset 0 0 0 1px #3ea1ff22}
  tbody tr:hover{background:#101a28}
  .note{color:var(--muted);font-size:12px;line-height:1.45}
  .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#1b2838;color:var(--ink);font-size:11px;border:1px solid #223044;box-shadow:0 0 0 1px #ffffff08}
  .ok{color:#7dffb0}.no{color:#ff6b6b}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  #gearVis{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
  #gearVis .col{background:#0c121a;border:1px solid #182232;border-radius:10px;padding:8px;text-align:center;box-shadow:inset 0 0 0 1px #ffffff08}
  #gearVis .val{font-size:18px;font-weight:700}
  #gearControls{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:8px}
  #gearControls button{width:auto;min-width:44px}
  #gearCanvas{height:260px}
  .narrow{max-width:520px}
  .small{font-size:11px}.muted{color:var(--muted)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar .group{display:flex;gap:6px;align-items:center}
  .toolbar .seg{display:inline-flex;border:1px solid #223044;border-radius:8px;overflow:hidden}
  .toolbar .seg button{border:none;background:#14202f;padding:6px 10px;font-size:12px;cursor:pointer;color:#cfe2ff}
  .toolbar .seg button.active{background:#1e2c40;color:#b9ffdb}

  /* Respect reduced motion for canvas animation only */
  @media (prefers-reduced-motion: reduce){
    /* canvas animation controlled in JS; no CSS motion left */
  }

  /* ---------- Tooltip system (desktop + mobile) ---------- */
  .help-icon{
    --size:18px;
    width:var(--size);height:var(--size);
    border-radius:50%;
    border:1px solid #2a3b55;
    background:radial-gradient(circle at 30% 30%, #234064, #0e1723);
    color:#cfe2ff;font-weight:800;font-size:12px;line-height:1;
    display:inline-flex;align-items:center;justify-content:center;
    cursor:help; position:relative; flex:0 0 auto;
  }
  .help-icon:focus-visible{outline:2px solid #4da3ff66;outline-offset:2px}
  .tip-bubble{
    position:absolute;left:50%;bottom:calc(100% + 8px);
    transform:translateX(-50%) translateY(6px) scale(.98);
    background:#0d1623;border:1px solid #243248;border-radius:10px;box-shadow:0 10px 30px #00000066, 0 0 0 1px #ffffff08;
    padding:10px; width:min(260px, 82vw); color:#e8eef6; font-size:12px; line-height:1.45; z-index:50;
    opacity:0; pointer-events:none; transition:opacity .15s ease, transform .15s ease;
  }
  .tip-bubble .tip-title{display:block;font-weight:700;color:#b9ffdb;margin-bottom:4px}
  .tip-bubble::after{
    content:"";position:absolute;left:50%;top:100%;transform:translateX(-50%);
    border-width:8px;border-style:solid;border-color:#0d1623 transparent transparent transparent;
    filter:drop-shadow(0 2px 0 #243248);
  }
  /* Show on hover/focus or when toggled open via JS */
  .help-icon:hover .tip-bubble,
  .help-icon:focus .tip-bubble,
  .help-icon.open .tip-bubble{
    opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0) scale(1);
  }
  /* Tooltip inside headers with less vertical space: push below if needed */
  .tip-below .tip-bubble{ top:calc(100% + 8px); bottom:auto }
  .tip-below .tip-bubble::after{
    top:auto; bottom:100%; transform:translateX(-50%) rotate(180deg)
  }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <h1 style="margin-right:auto">Mid-Drive Planner v10</h1>
    <div class="group">
      <span class="small muted">Speed</span>
      <div class="seg" role="tablist" aria-label="Speed units">
        <button type="button" id="u_mph" class="active" aria-selected="true">mph</button>
        <button type="button" id="u_kph" aria-selected="false">km/h</button>
      </div>
    </div>
    <div class="group">
      <span class="small muted">FX</span>
      <div class="seg" role="tablist" aria-label="Visual effects">
        <button type="button" id="fx_on" class="active" aria-selected="true">On</button>
        <button type="button" id="fx_off" aria-selected="false">Off</button>
      </div>
      <button id="fx_play" class="btn secondary" type="button" style="min-width:88px">Pause</button>
    </div>
  </div>
  <div class="sub">No distracting sweeps. Animated sprockets & chain remain. Tap the ‚Äú?‚Äù icons for inline help (works on mobile).</div>
</header>

<main class="grid">
  <!-- LEFT PANEL -->
  <section class="card">
    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üö≤</span>
        Bike
      </div>
      <div class="inputs">
        <div><label for="wheelPreset">Wheel size preset</label>
          <select id="wheelPreset">
            <option value="2100">26‚Ä≥ (‚âà2100 mm)</option>
            <option value="2230">27.5‚Ä≥ (‚âà2230 mm)</option>
            <option value="2310">29‚Ä≥ / 700c (‚âà2310 mm)</option>
            <option value="custom">Use custom circumference</option>
          </select>
        </div>
        <div><label for="circumference">Custom circumference (mm)</label><input id="circumference" type="number" placeholder="e.g. 2100" min="1" step="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">‚öôÔ∏è</span>
        Drivetrain
      </div>
      <div class="inputs">
        <div><label for="frontTeeth">Front chainring teeth</label><input id="frontTeeth" type="number" value="40" min="22" max="60" step="1"></div>
        <div><label for="rearCogs">Rear cogs (teeth, CSV)</label><input id="rearCogs" class="full" type="text" value="13,14,16,18,21,24,28,34" inputmode="numeric"></div>
        <div><label for="driveEff">Drivetrain efficiency</label><input id="driveEff" type="number" step="0.01" value="0.95" min="0" max="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üë§</span>
        Rider
      </div>
      <div class="inputs">
        <div><label for="mass">Total mass (kg)</label><input id="mass" type="number" value="160" min="1" step="0.1"></div>
        <div><label for="riderW">Rider watts</label><input id="riderW" type="number" value="0" min="0" step="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üìà</span>
        Grades
      </div>
      <div class="inputs">
        <div><label for="climbMph"><span id="lbl_climb">Target climb speed (mph)</span></label><input id="climbMph" type="number" value="3" min="0" step="0.1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">‚ö°</span>
        Motor
      </div>
      <div class="inputs">
        <div><label for="crankTorque">Crank torque (Nm)</label><input id="crankTorque" type="number" value="160" min="0" step="0.1"></div>
        <div><label for="maxCadence">Max chainring rpm</label><input id="maxCadence" type="number" value="140" min="0" step="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üîå</span>
        Power
      </div>
      <div class="inputs">
        <div class="full"><label for="powerMode">Power entry mode</label>
          <select id="powerMode">
            <option value="va">Voltage √ó Current √ó Efficiency (battery-based)</option>
            <option value="mech">Direct mechanical watts (at the shaft)</option>
          </select>
        </div>
        <div><label for="voltage">Battery voltage (V)</label><input id="voltage" type="number" value="52" min="0" step="0.1"></div>
        <div><label for="current">Controller current (A)</label><input id="current" type="number" value="30" min="0" step="0.1"></div>
        <div><label for="motorEff">Motor+controller efficiency</label><input id="motorEff" type="number" step="0.01" value="0.82" min="0" max="1"></div>
        <div><label for="mechW">Mechanical watts (if using direct)</label><input id="mechW" type="number" value="1280" min="0" step="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üîã</span>
        Battery
      </div>
      <div class="inputs">
        <div><label for="batAh">Battery capacity (Ah)</label><input id="batAh" type="number" value="20" min="0" step="0.1"></div>
        <div><label for="usablePct">Usable % (leave reserve)</label><input id="usablePct" type="number" value="85" min="0" max="100" step="1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üìè</span>
        Range
      </div>
      <div class="inputs">
        <div><label for="rangeMph"><span id="lbl_range">Range cruise speed (mph)</span></label><input id="rangeMph" type="number" value="20" min="0" step="0.1"></div>
        <div><label for="rangeGradePct">Target climb grade for range (%)</label><input id="rangeGradePct" type="number" value="10" min="0" step="0.1"></div>
      </div>
    </div>

    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üíæ</span>
        Presets & Share
      </div>
      <div class="row">
        <button class="pill" data-rear="14,16,18,20,22,24,26">7-spd 14‚Äì26</button>
        <button class="pill" data-rear="13,14,16,18,21,24,28,34">MegaRange 13‚Äì34</button>
        <button class="pill" data-rear="12,14,16,18,21,24,28,32">8-spd 12‚Äì32</button>
        <button class="pill" id="preset_power">52 V √ó 30 A (0.82)</button>
        <button class="pill" id="preset_rpm">Spec: 150 rpm</button>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="presetName" placeholder="Preset name" style="max-width:220px" aria-label="Preset name">
        <button id="savePreset" class="btn secondary" type="button">Save</button>
        <select id="loadPreset" style="max-width:220px"><option value="">Load preset‚Ä¶</option></select>
        <button id="deletePreset" class="btn secondary" type="button">Delete</button>
        <button id="shareBtn" class="btn" type="button">Share</button>
        <span id="shareMsg" class="small muted" role="status" aria-live="polite"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="computeBtn" class="btn" type="button">Compute</button>
        <button id="resetBtn" class="btn secondary" type="button">Reset defaults</button>
        <button id="exportCsv" class="btn secondary" type="button">Export CSV</button>
      </div>
    </div>
  </section>

  <!-- RIGHT PANEL -->
  <section class="card">
    <div class="section-title">Global summary</div>
    <div id="summary" class="note" role="status" aria-live="polite"></div>

    <div class="two-col" style="gap:12px; margin-top:10px">
      <div>
        <div class="section-title">Range estimate</div>
        <div id="rangeBox" class="note" role="status" aria-live="polite"></div>
      </div>
      <div>
        <div class="section-title">Slope per gear (visual)</div>
        <canvas id="chartSlope" style="height:200px" role="img" aria-label="Per-gear slope visualisation"></canvas>
      </div>
    </div>

    <div class="section-title" style="margin-top:12px">Gear visualizer ‚Äî chainring ‚Üí cog ‚Üí wheel</div>
    <div class="narrow">
      <div class="row">
        <label for="visRpm">Visualizer chainring rpm</label>
        <input id="visRpm" type="range" min="0" max="200" value="1" step="1" style="flex:1">
        <input id="visRpmNum" type="number" value="1" min="0" max="300" step="1" style="width:90px">
      </div>
    </div>
    <div id="gearVis">
      <div class="col">
        <div class="note">Chainring</div>
        <div class="val" id="gv_crank_rpm">1.00 rpm</div>
        <div class="note" id="gv_frontT">‚Äî</div>
      </div>
      <div style="text-align:center">
        <div id="gearControls">
          <button id="gearDown" class="btn" title="Shift to a smaller rear sprocket (harder gear)" aria-label="Shift down">‚ñº</button>
          <div class="badge" id="gv_label">Gear 1/‚Äî</div>
          <button id="gearUp" class="btn" title="Shift to a larger rear sprocket (easier gear)" aria-label="Shift up">‚ñ≤</button>
        </div>
        <div class="note" id="gv_ratio">ratio ‚Äî</div>
      </div>
      <div class="col">
        <div class="note">Wheel</div>
        <div class="val" id="gv_wheel_rpm">‚Äî rpm</div>
        <div class="note" id="gv_speed">‚Äî</div>
      </div>
    </div>
    <canvas id="gearCanvas" role="img" aria-label="Animated chainring, cog and wheel with chain motion"></canvas>

    <div class="section-title" style="margin-top:12px">Per-gear results</div>
    <div class="note" style="margin-bottom:6px">
      <span class="badge">Columns</span>
      ‚ÄúTop speed (rpm-limit)‚Äù = speed at your chainring rpm cap in that gear. 
      ‚ÄúMax grade (torque @v)‚Äù uses your set climb speed. ‚ÄúActual‚Äù = min(power-limit, torque-limit).
    </div>
    <div style="overflow:auto">
      <table id="resultTable">
        <thead><tr>
          <th>Gear</th><th>Ratio</th><th id="th_top">Top speed (mph)</th>
          <th>Wheel torque (Nm)</th><th>Max grade (torque @v)</th><th>Max grade (actual @v)</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section-title" style="margin-top:8px">Gear summary</div>
    <div id="gearSummary" class="note"></div>

    <div class="section-title" style="margin-top:14px">Charts</div>
    <div class="grid" style="grid-template-columns:1fr;gap:10px">
      <canvas id="chartSpeed" role="img" aria-label="Top speed per gear line chart"></canvas>
      <canvas id="chartTorque" role="img" aria-label="Wheel torque per gear line chart"></canvas>
      <canvas id="chartGrade" role="img" aria-label="Maximum climb grade per gear line chart"></canvas>
    </div>
  </section>

  <!-- Reverse engineer -->
  <section class="card">
    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üîÑ</span>
        Reverse engineer gearing
      </div>
      <div class="inputs">
        <div><label for="targetTopMph"><span id="lbl_targetTop">Target top speed (mph)</span></label><input id="targetTopMph" type="number" value="29" min="0" step="0.1"></div>
        <div><label for="targetGradePct">Target climb grade (%)</label><input id="targetGradePct" type="number" value="15" min="0" step="0.1"></div>
        <div class="full"><label for="fixedWhat">What is fixed?</label>
          <select id="fixedWhat">
            <option value="none">Nothing (suggest both)</option>
            <option value="ring">Chainring is fixed</option>
            <option value="cassette">Cassette extremes are fixed</option>
          </select>
        </div>
        <div><label for="fixedRing">Fixed ring (T)</label><input id="fixedRing" type="number" value="40" min="1" step="1"></div>
        <div><label for="fixedSmall">Fixed cassette small (T)</label><input id="fixedSmall" type="number" value="13" min="1" step="1"></div>
        <div><label for="fixedLarge">Fixed cassette large (T)</label><input id="fixedLarge" type="number" value="34" min="1" step="1"></div>
        <div class="full"><button id="solveBtn" class="btn" type="button">Solve gearing</button></div>
      </div>
      <div id="solveOut" class="note" style="margin-top:8px" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- Uncertainty -->
  <section class="card">
    <div class="input-section">
      <div class="section-title">
        <span class="section-icon">üé≤</span>
        Uncertainty sweeps (multi-scenario)
      </div>
      <div class="note" style="margin-bottom:12px">Use this to simulate uncertainty by running many scenarios with ranges for key variables. Set min/max for each, then click Run to get the percentage of scenarios that meet your targets and gearing suggestions for robust design. The coverage shows reliability, and the design recommendations help choose components that work across variations.</div>
      <div class="inputs">
        <div><label for="N"># samples</label><input id="N" type="number" value="300" min="10" step="1"></div>
        <div><label for="u_mass_min">Mass min (kg)</label><input id="u_mass_min" type="number" value="150" min="1" step="0.1"></div>
        <div><label for="u_mass_max">Mass max (kg)</label><input id="u_mass_max" type="number" value="170" min="1" step="0.1"></div>
        <div><label for="u_rpm_min">Max chainring rpm min</label><input id="u_rpm_min" type="number" value="130" min="0" step="1"></div>
        <div><label for="u_rpm_max">Max chainring rpm max</label><input id="u_rpm_max" type="number" value="150" min="0" step="1"></div>
        <div><label for="u_V_min">Voltage min</label><input id="u_V_min" type="number" value="50" min="0" step="0.1"></div>
        <div><label for="u_V_max">Voltage max</label><input id="u_V_max" type="number" value="58" min="0" step="0.1"></div>
        <div><label for="u_A_min">Current min</label><input id="u_A_min" type="number" value="28" min="0" step="0.1"></div>
        <div><label for="u_A_max">Current max</label><input id="u_A_max" type="number" value="35" min="0" step="0.1"></div>
        <div><label for="u_eff_min">Eff min</label><input id="u_eff_min" type="number" step="0.01" value="0.78" min="0" max="1"></div>
        <div><label for="u_eff_max">Eff max</label><input id="u_eff_max" type="number" step="0.01" value="0.85" min="0" max="1"></div>
        <div><label for="u_T_min">Crank torque min (Nm)</label><input id="u_T_min" type="number" value="140" min="0" step="0.1"></div>
        <div><label for="u_T_max">Crank torque max (Nm)</label><input id="u_T_max" type="number" value="170" min="0" step="0.1"></div>
        <div><label for="u_RW_min">Rider W min</label><input id="u_RW_min" type="number" value="0" min="0" step="1"></div>
        <div><label for="u_RW_max">Rider W max</label><input id="u_RW_max" type="number" value="150" min="0" step="1"></div>
        <div class="full"><button id="uncBtn" class="btn" type="button">Run uncertainty</button></div>
      </div>
      <div id="uncOut" class="note" style="margin-top:8px" role="status" aria-live="polite"></div>
    </div>
  </section>
</main>

<script>
/* ====== Core constants + existing compute/render engine (kept) ====== */
(function(){
  const g = 9.80665;
  const MPH_PER_MPS = 2.23693629;
  const KPH_PER_MPS = 3.6;
  const MPS_PER_MPH = 0.44704;
  const stdSmall = [11,12,13,14];
  const stdLarge = [26,28,30,32,34,36,40,42,46,50];

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));

  let gearIndex = 0;
  let firstCompute = true;
  let speedUnit = 'mph'; // 'mph' | 'kph'

  // FX state (canvas animation only)
  const prefersReduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  let fxEnabled = !prefersReduce;
  let animRunning = !prefersReduce;

  /* ---------- helpers ---------- */
  function parseRear(csv){
    const set = new Set();
    csv.split(',').forEach(s=>{
      const n = parseInt(s.trim(),10);
      if(Number.isFinite(n) && n > 0) set.add(n);
    });
    return Array.from(set).sort((a,b)=>a-b);
  }
  function getCirc(){
    const p = $('#wheelPreset').value;
    const c = parseFloat($('#circumference').value);
    if(p==='custom') return (c>0?c:2100)/1000;
    const mm = parseFloat(p);
    return (c>0 ? c : (mm>0?mm:2100))/1000;
  }
  function binSearchTopSpeedFlat(P, m, Crr, rho, CdA){
    let lo=0, hi=35;
    for(let i=0;i<64;i++){
      const v=(lo+hi)/2;
      const f = 0.5*rho*CdA*v*v*v + m*g*Crr*v - P;
      if(f>0) hi=v; else lo=v;
    }
    return (lo+hi)/2;
  }
  function fmt(n, d=2){ return Number.isFinite(n)? n.toFixed(d) : '‚Äî'; }
  function mphToDisplay(mph){ return speedUnit==='mph' ? mph : mph*1.609344; }
  function mpsToDisplay(mps){ return speedUnit==='mph' ? (mps*MPH_PER_MPS) : (mps*KPH_PER_MPS); }
  function unitLabel(){ return speedUnit==='mph' ? 'mph' : 'km/h'; }
  function setSpeedLabels(){
    $('#lbl_climb').textContent = `Target climb speed (${unitLabel()})`;
    $('#lbl_range').textContent = `Range cruise speed (${unitLabel()})`;
    $('#lbl_targetTop').textContent = `Target top speed (${unitLabel()})`;
    $('#th_top').textContent = `Top speed (${unitLabel()})`;
  }
  function getSpeedInputMph(id){
    const val = parseFloat($('#'+id).value) || 0;
    return speedUnit==='mph' ? val : (val/1.609344);
  }
  function setSpeedInputDisplayFromMph(id, mph){
    const v = speedUnit==='mph' ? mph : mph*1.609344;
    $('#'+id).value = +v.toFixed(2);
  }
  function clampGear(n, rears){ return Math.max(0, Math.min(n, rears.length-1)); }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  /* ---------- charts & slope ---------- */
  function drawChart(canvas, labels, series, options){
    const dpr=Math.max(1,window.devicePixelRatio||1), w=canvas.clientWidth, h=canvas.clientHeight;
    canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr);
    const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h);
    const pad={l:44,r:10,t:16,b:30}, plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b;
    ctx.fillStyle='#a9b7c6'; ctx.font='12px system-ui,sans-serif'; ctx.textAlign='left'; ctx.textBaseline='top';
    if(options&&options.title) ctx.fillText(options.title,pad.l,4);
    let ymin=Infinity,ymax=-Infinity;
    series.forEach(s=>s.data.forEach(v=>{ if(v==null)return; ymin=Math.min(ymin,v); ymax=Math.max(ymax,v);})); 
    if(!isFinite(ymin)||!isFinite(ymax)){ymin=0;ymax=1;} if(ymin===ymax){ymin=0;ymax=ymax||1;}
    const padY=(ymax-ymin)*0.08||1; ymin-=padY; ymax+=padY;
    const xTo=(i)=> pad.l + (plotW*(labels.length<=1?0:i/(labels.length-1)));
    const yTo=(v)=> pad.t + plotH*(1 - (v - ymin)/(ymax - ymin));
    const grid='#233040'; const ax='#7d92a9';
    const pal=['#4da3ff','#7dffb0','#ffb84d','#ff6b6b','#c18bff'];
    ctx.strokeStyle=grid; ctx.lineWidth=1; ctx.beginPath();
    for(let gy=0;gy<=5;gy++){ const y=pad.t + plotH*gy/5; ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+plotW,y); } ctx.stroke();
    ctx.fillStyle=ax; ctx.textAlign='right'; ctx.textBaseline='middle';
    for(let gy=0;gy<=5;gy++){ const v=ymin+(ymax-ymin)*gy/5; ctx.fillText((options&&options.formatY?options.formatY(v):v.toFixed(1)), pad.l-6, yTo(v)); }
    ctx.textAlign='center'; ctx.textBaseline='top';
    labels.forEach((lab,i)=> ctx.fillText(lab, xTo(i), pad.t+plotH+6));
    series.forEach((s,si)=>{
      ctx.lineWidth=2; ctx.strokeStyle=s.color||pal[si%pal.length]; ctx.setLineDash(s.dashed?[5,4]:[]);
      ctx.beginPath();
      s.data.forEach((v,i)=>{ if(v==null)return; const x=xTo(i), y=yTo(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
      if(!s.hidePoints){
        s.data.forEach((v,i)=>{ if(v==null)return; const x=xTo(i), y=yTo(v); ctx.fillStyle=s.color||pal[si%pal.length]; ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
      }
    });
  }
  function drawSlopeVisual(canvas, labels, gradePctList){
    const dpr=Math.max(1,window.devicePixelRatio||1), w=canvas.clientWidth, h=canvas.clientHeight;
    canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr);
    const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h);
    const pad={l:10,r:10,t:10,b:36};
    const plotW=w-pad.l-pad.r, plotH=h-pad.t-pad.b;
    const N = labels.length; if(N===0) return;
    const colW = plotW / N;
    ctx.fillStyle='#7f92a9'; ctx.font='11px system-ui,sans-serif'; ctx.textAlign='center';
    for(let i=0;i<N;i++){
      const pct = gradePctList[i]||0;
      const theta = Math.atan((pct)/100);
      const len = Math.min(40, colW*0.8);
      const cx = pad.l + colW*(i+0.5);
      const cy = pad.t + plotH*0.65;
      ctx.save(); ctx.translate(cx, cy); ctx.rotate(-theta);
      ctx.fillStyle='#1a2634'; ctx.fillRect(-len/2, -4, len, 8);
      ctx.strokeStyle='#2b3b52'; ctx.lineWidth=1;
      for(let s=-len/2; s<=len/2; s+=8){ ctx.beginPath(); ctx.moveTo(s, -4); ctx.lineTo(s+4, 4); ctx.stroke(); }
      ctx.restore();
      ctx.fillStyle='#a9b7c6'; ctx.fillText(labels[i], cx, h - 22);
      ctx.fillStyle='#7dffb0'; ctx.fillText(`${pct.toFixed(0)}%`, cx, h - 10);
    }
  }

  /* ---------- Sexy Gear Canvas Animation ---------- */
  let animId = null, lastT = 0, angFront = 0, angRear = 0, angWheel = 0, chainOffset = 0;

  function drawSprocket(ctx, x, y, baseR, teeth, angle, color){
    const toothH = 6, innerR = baseR-4, outerR = baseR+toothH;
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(angle);
    ctx.lineWidth=2;
    ctx.shadowColor=color; ctx.shadowBlur=10;
    ctx.strokeStyle=color;
    ctx.beginPath(); ctx.arc(0,0,baseR,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle = color; ctx.globalAlpha=0.85;
    for(let i=0;i<teeth;i++){
      const a = i*2*Math.PI/teeth;
      const w = Math.max(4, (2*Math.PI*baseR/teeth)*0.25);
      ctx.save(); ctx.rotate(a);
      ctx.beginPath();
      ctx.moveTo(innerR, -w*0.5);
      ctx.lineTo(outerR, -w*0.3);
      ctx.lineTo(outerR,  w*0.3);
      ctx.lineTo(innerR,  w*0.5);
      ctx.closePath(); ctx.fill();
      ctx.restore();
    }
    ctx.globalAlpha=1;
    ctx.beginPath(); ctx.arc(0,0,innerR,0,Math.PI*2); ctx.strokeStyle="#1b2a40"; ctx.stroke();
    ctx.restore();
  }

  function drawWheel(ctx,x,y,r,angle){
    ctx.save(); ctx.translate(x,y); ctx.rotate(angle);
    ctx.shadowColor= "#7dffb0"; ctx.shadowBlur=10;
    ctx.strokeStyle="#7dffb0"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
    const spokeN=16;
    ctx.lineWidth=1.2; ctx.strokeStyle="#aefcd2";
    for(let i=0;i<spokeN;i++){
      const a = i*2*Math.PI/spokeN;
      const x1 = r*0.1*Math.cos(a+Math.PI/8), y1 = r*0.1*Math.sin(a+Math.PI/8);
      const x2 = r*Math.cos(a), y2 = r*Math.sin(a);
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    }
    ctx.fillStyle="#0e1a28"; ctx.beginPath(); ctx.arc(0,0,r*0.12,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function drawChain(ctx, path, linkSpacing, offset, color){
    ctx.save();
    ctx.fillStyle=color; ctx.shadowColor=color; ctx.shadowBlur=6;
    const totalLen = path.reduce((s,seg)=>s+Math.hypot(seg.x2-seg.x1, seg.y2-seg.y1),0);
    let s0 = (-offset % linkSpacing + linkSpacing) % linkSpacing;
    for(let s=s0; s<totalLen; s+=linkSpacing){
      let d = s;
      for(const seg of path){
        const L = Math.hypot(seg.x2-seg.x1, seg.y2-seg.y1);
        if(d<=L){
          const t = d/L;
          const x = seg.x1 + (seg.x2-seg.x1)*t;
          const y = seg.y1 + (seg.y2-seg.y1)*t;
          const ang = Math.atan2(seg.y2-seg.y1, seg.x2-seg.x1);
          const w=10, h=3;
          ctx.save(); ctx.translate(x,y); ctx.rotate(ang);
          ctx.globalAlpha=0.95; ctx.fillRect(-w/2,-h/2,w,h);
          ctx.restore();
          break;
        } else { d-=L; }
      }
    }
    ctx.restore();
  }

  function drawGearCanvas(rears){
    const canvas = $('#gearCanvas');
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const w = canvas.clientWidth, h = canvas.clientHeight;
    canvas.width = Math.round(w*dpr); canvas.height = Math.round(h*dpr);
    const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);

    if(!rears.length) return;
    const frontT = parseInt($('#frontTeeth').value,10)||40;
    const rearT  = rears[gearIndex];
    const circ   = getCirc();
    const visRpm = Math.max(0, parseFloat($('#visRpmNum').value)||1);

    const pad = {l:24, r:24, t:20, b:20};
    const leftX = pad.l + 70;
    const midX = w/2 + 30;
    const wheelX = w - 140;
    const centerY = h/2 + 8;

    const rFront = Math.max(20, Math.sqrt(frontT)*2.4);
    const rRear  = Math.max(12, Math.sqrt(rearT)*2.3);
    const rWheel = Math.min(100, Math.max(70, (circ/(2*Math.PI))*36));

    const dy = 10;
    const top = [
      {x1:leftX + rFront, y1:centerY - dy, x2:midX - rRear, y2:centerY - dy},
      {x1:midX - rRear,   y1:centerY - dy, x2:midX - rRear, y2:centerY - dy}
    ];
    const bottom = [{x1:midX - rRear, y1:centerY + dy, x2:leftX + rFront, y2:centerY + dy}];

    const ratio   = frontT/rearT;
    const wheelRpm = visRpm * ratio;

    drawSprocket(ctx,leftX, centerY, rFront, frontT, angFront, "#4da3ff");
    drawSprocket(ctx, midX,  centerY, rRear,  rearT,  angRear,  "#ffb84d");
    drawWheel   (ctx, wheelX,centerY, rWheel, angWheel);

    drawChain(ctx, top,    16, chainOffset, "#8fd0ff");
    drawChain(ctx, bottom, 16, chainOffset - (top.reduce((s,seg)=>s+Math.hypot(seg.x2-seg.x1, seg.y2-seg.y1),0)), "#8fd0ff");

    ctx.fillStyle='#a9b7c6'; ctx.font='12px system-ui,sans-serif'; ctx.textAlign='center';
    ctx.fillText(`${frontT}T ring`, leftX, centerY - rFront - 14);
    ctx.fillText(`${rearT}T cog`,  midX,  centerY - rRear  - 14);
    ctx.fillText(`Wheel`,         wheelX, centerY - rWheel - 14);

    ctx.font='13px system-ui,sans-serif';
    ctx.fillStyle='#cfe2ff';  ctx.fillText(`${visRpm.toFixed(1)} rpm`, leftX, centerY + rFront + 18);
    ctx.fillStyle='#ffe2b5';  ctx.fillText(`${(visRpm*ratio).toFixed(1)} rpm`, midX,  centerY + rRear  + 18);
    const speed_mps = (wheelRpm/60) * circ;
    const speed_disp = mpsToDisplay(speed_mps);
    ctx.fillStyle='#b9ffdb'; ctx.fillText(`${(wheelRpm).toFixed(1)} rpm  ‚Ä¢  ${speed_disp.toFixed(2)} ${unitLabel()}`, wheelX, centerY + rWheel + 18);
  }

  function updateGearButtons(rears){
    $('#gearDown').disabled = (gearIndex<=0);
    $('#gearUp').disabled   = (gearIndex>=rears.length-1);
  }

  function updateGearVisualizer(rears){
    if(!rears.length) return;
    gearIndex = clampGear(gearIndex, rears);
    const front=parseInt($('#frontTeeth').value,10) || 40;
    const visRpm = parseFloat($('#visRpmNum').value)||1;
    const rear = rears[gearIndex];
    const ratio = front / rear;
    const circ=getCirc();
    const wheel_rpm = ratio * visRpm;
    const speed_mps = (wheel_rpm/60) * circ;
    const speed_disp = mpsToDisplay(speed_mps);
    $('#gv_label').textContent = `Gear ${gearIndex+1}/${rears.length} ‚Äî ${front}/${rear}T`;
    $('#gv_ratio').textContent = `ratio = front/rear = ${front}/${rear} = ${ratio.toFixed(2)}√ó`;
    $('#gv_frontT').textContent = `${front}T ring`;
    $('#gv_crank_rpm').textContent = `${visRpm.toFixed(2)} rpm`;
    $('#gv_wheel_rpm').textContent = `${wheel_rpm.toFixed(2)} rpm`;
    $('#gv_speed').textContent = `${speed_disp.toFixed(2)} ${unitLabel()}`;
    drawGearCanvas(parseRear($('#rearCogs').value));
  }

  /* ---------- Main compute ---------- */
  function compute(){
    const circ=getCirc(), radius=circ/(2*Math.PI);
    const front=parseInt($('#frontTeeth').value,10);
    const rears=parseRear($('#rearCogs').value);

    if(firstCompute){ gearIndex = Math.max(0, Math.floor(rears.length/2)); firstCompute=false; }
    gearIndex = clampGear(gearIndex, rears);

    const m   = parseFloat($('#mass').value);
    const Crr = 0.006;
    const CdA = 0.60;
    const rho = 1.20;
    const riderW = Math.max(0, parseFloat($('#riderW').value));
    const Tcrank = parseFloat($('#crankTorque').value);
    const chainEff = parseFloat($('#driveEff').value);
    const V   = parseFloat($('#voltage').value);
    const A   = parseFloat($('#current').value);
    const motorEff = Math.min(1, Math.max(0, parseFloat($('#motorEff').value)));
    const maxCad = parseFloat($('#maxCadence').value);
    const climbMph = getSpeedInputMph('climbMph');
    const vclimb = climbMph*MPS_PER_MPH;

    const mode=$('#powerMode').value;
    let P_mech=0, P_batt=0;
    if(mode==='va'){ P_batt=V*A; P_mech=P_batt*motorEff; } else { P_mech=Math.max(0,parseFloat($('#mechW').value)||0); P_batt=P_mech/Math.max(0.01,motorEff); }
    P_mech += riderW;

    const vFlat = binSearchTopSpeedFlat(P_mech, m, Crr, rho, CdA);
    const topFlatMph = vFlat*MPH_PER_MPS;

    const labels=rears.map(t=>t+'T');
    const speedTopDisp=[], torqueNm=[], gradeTorque=[], gradeActual=[];
    const rows=[];

    const reqN_power = (P_mech/vclimb) - 0.5*rho*CdA*vclimb*vclimb;
    const gPower = (reqN_power/(m*g)) - Crr;
    const gPowerPct = Math.max(0, gPower*100);

    rears.forEach(rear=>{
      const ratio=front/rear;
      const speed_mps = maxCad*ratio*circ/60;
      const top_disp = mpsToDisplay(speed_mps);
      const Tw = Tcrank*(rear/front)*chainEff;
      const thrust = Tw / radius;
      const gTorque = ((thrust - 0.5*rho*CdA*vclimb*vclimb)/(m*g)) - Crr;
      const gTorquePct = Math.max(0,gTorque*100);
      const gActualPct = Math.max(0, Math.min(gTorquePct, gPowerPct));

      rows.push({gear:`${front}/${rear}`, ratio:(front/rear).toFixed(2), top:top_disp.toFixed(1), tw:Tw.toFixed(1),
                 gt:gTorquePct.toFixed(1)+'%', ga:gActualPct.toFixed(1)+'%'});

      speedTopDisp.push(top_disp); torqueNm.push(Tw); gradeTorque.push(gTorquePct); gradeActual.push(gActualPct);
    });

    const topRear = rears[0]||13;
    const topGearRpmMps = (maxCad*(front/topRear)*circ/60);
    const topGearRpmDisp = mpsToDisplay(topGearRpmMps);
    const overallTop = Math.min(topGearRpmDisp, mphToDisplay(topFlatMph));

    $('#summary').innerHTML = `
      <div><span class="badge">Wheel</span> circumference ‚âà <b>${(circ*1000).toFixed(0)} mm</b></div>
      <div style="margin-top:4px"><span class="badge">Power</span> mech <b>${fmt(P_mech,0)} W</b> (incl. rider ${fmt(riderW,0)} W) ‚Ä¢ battery draw ‚âà <b>${fmt(P_batt,0)} W</b>.</div>
      <div style="margin-top:4px"><span class="badge">Top speed</span> flat power-limit <b>${fmt(mphToDisplay(topFlatMph),1)} ${unitLabel()}</b> ‚Ä¢ top-gear rpm-limit <b>${fmt(topGearRpmDisp,1)} ${unitLabel()}</b> ‚Üí <b>overall ‚âà ${fmt(overallTop,1)} ${unitLabel()}</b></div>
      <div style="margin-top:4px"><span class="badge">Power-limited grade @ ${fmt(mphToDisplay(climbMph),1)} ${unitLabel()}</span> <b>${fmt(gPowerPct,1)}%</b> (gear-independent)</div>
    `;

    const ratios = rears.map(r=>front/r).sort((a,b)=>a-b);
    const gearRange = ratios[ratios.length-1] / ratios[0];
    let steps=[]; for(let i=1;i<ratios.length;i++){ steps.push((ratios[i]/ratios[i-1]-1)*100); }
    const avgStep = steps.length? (steps.reduce((a,b)=>a+b,0)/steps.length) : 0;
    $('#gearSummary').innerHTML = `
      <div><span class="badge">Ratio range</span> <b>${fmt(gearRange,2)}√ó</b> (low ${fmt(ratios[0],2)} ‚Üí high ${fmt(ratios[ratios.length-1],2)})</div>
      <div style="margin-top:4px"><span class="badge">Avg step</span> ${fmt(avgStep,1)}% between adjacent gears</div>
    `;

    const tbody=$('#resultTable tbody');
    tbody.innerHTML = rows.map((r,i)=>`<tr data-gi="${i}"><td>${r.gear}</td><td>${r.ratio}</td><td>${r.top}</td><td>${r.tw}</td><td>${r.gt}</td><td>${r.ga}</td></tr>`).join('');
    highlightSelectedRow();

    drawChart($('#chartSpeed'), labels, [
      {name:`Top speed (${unitLabel()})`, data:speedTopDisp, color:'#4da3ff'},
      {name:`Flat power-limit (${unitLabel()})`, data:labels.map(_=>mphToDisplay(topFlatMph)), color:'#7dffb0', dashed:true, hidePoints:true}
    ], {title:`Top Speed per Gear (${unitLabel()})`, formatY:v=>v.toFixed(0)});

    drawChart($('#chartTorque'), labels, [
      {name:'Wheel torque (Nm)', data:torqueNm, color:'#ffb84d'}
    ], {title:'Wheel Torque per Gear', formatY:v=>v.toFixed(0)+' Nm'});

    drawChart($('#chartGrade'), labels, [
      {name:'Max grade (actual @v)', data:gradeActual, color:'#7dffb0'},
      {name:'Torque-limited @v', data:gradeTorque, color:'#4da3ff', dashed:true},
      {name:'Power-limited @v (global)', data:labels.map(_=>gPowerPct), color:'#ff6b6b', dashed:true, hidePoints:true}
    ], {title:`Max Grade at ${fmt(mphToDisplay(climbMph),1)} ${unitLabel()} (per gear)`, formatY:v=>v.toFixed(0)+'%'});

    drawSlopeVisual($('#chartSlope'), labels, gradeActual);
    updateGearVisualizer(rears);
    updateGearButtons(rears);
    calcRange();
  }

  /* ---------- Range box ---------- */
  function calcRange(){
    const batAh = parseFloat($('#batAh').value)||0;
    const usablePct = Math.min(100, Math.max(0, parseFloat($('#usablePct').value)||0));
    const V = parseFloat($('#voltage').value)||0;
    const motorEff = Math.min(1, Math.max(0, parseFloat($('#motorEff').value)||0));
    const riderW = Math.max(0, parseFloat($('#riderW').value)||0);
    const m = parseFloat($('#mass').value)||0;
    const Crr = 0.006;
    const CdA = 0.60;
    const rho = 1.20;
    const cruiseMph = getSpeedInputMph('rangeMph');
    const v = cruiseMph*MPS_PER_MPH;
    const grade = (parseFloat($('#rangeGradePct').value)||0)/100;

    const usableWh = batAh * V * (usablePct/100);
    const Paero = 0.5*rho*CdA*v*v*v;
    const Proll = m*g*Crr*v;
    const Pgrav = m*g*grade*v;
    const Ptotal = Paero + Proll + Pgrav;
    const Pmotor_mech = Math.max(0, Ptotal - riderW);
    const P_batt = motorEff>0 ? Pmotor_mech / motorEff : Infinity;

    let text='';
    if(!isFinite(P_batt) || P_batt<=0 || usableWh<=0 || v<=0){
      text = `<div class="no">Insufficient data for range (check battery, efficiency and speed).</div>`;
    } else {
      const hours = usableWh / P_batt;
      const dist_miles = hours * cruiseMph;
      const dist_km = dist_miles * 1.609344;
      const h = Math.floor(hours);
      const mins = Math.floor((hours - h)*60);
      text = `
        <div><span class="badge">Usable energy</span> <b>${fmt(usableWh,0)} Wh</b></div>
        <div style="height:6px"></div>
        <div><span class="badge">Cruise @ ${fmt(mphToDisplay(cruiseMph),1)} ${unitLabel()}, grade ${fmt(grade*100,1)}%</span> 
          battery draw ‚âà <b>${fmt(P_batt,0)} W</b> ‚Ä¢ ride time ‚âà <b>${h}h ${mins}m</b></div>
        <div style="margin-top:4px"><span class="badge">Estimated range</span> <b>${fmt(dist_miles,1)} mi</b> / <b>${fmt(dist_km,1)} km</b></div>
        <div class="small muted" style="margin-top:4px">Includes rider watts; assumes steady conditions, no starts/stops, no wind.</div>
      `;
    }
    $('#rangeBox').innerHTML = text;
  }

  /* ---------- Solver & Uncertainty ---------- */
  function solve(){
    const circ=getCirc(), radius=circ/(2*Math.PI);
    const m=parseFloat($('#mass').value), Crr=0.006, CdA=0.60, rho=1.20;
    const riderW=Math.max(0,parseFloat($('#riderW').value));
    const Tcrank=parseFloat($('#crankTorque').value), eff=parseFloat($('#driveEff').value);
    const V=parseFloat($('#voltage').value), A=parseFloat($('#current').value), motorEff=parseFloat($('#motorEff').value);
    const maxCad=parseFloat($('#maxCadence').value);
    const climbMph=getSpeedInputMph('climbMph'), v=climbMph*MPS_PER_MPH;
    const targetTopMph=getSpeedInputMph('targetTopMph'), targetGrade=(parseFloat($('#targetGradePct').value)||0)/100;
    const fixedWhat=$('#fixedWhat').value;
    const fixedRing=parseInt($('#fixedRing').value,10);
    const fixedSmall=parseInt($('#fixedSmall').value,10);
    const fixedLarge=parseInt($('#fixedLarge').value,10);

    const mode=$('#powerMode').value;
    let P_mech=0;
    if(mode==='va'){ P_mech=V*A*motorEff; } else { P_mech=Math.max(0,parseFloat($('#mechW').value)||0); }
    P_mech += riderW;

    const vFlat = binSearchTopSpeedFlat(P_mech, m, Crr, rho, CdA);
    const topFlatMph = vFlat*MPH_PER_MPS;
    const needTopMps = targetTopMph * MPS_PER_MPH;
    const ratioReq = needTopMps*60/(maxCad*circ);
    const Tw_req = (((targetGrade + Crr)*m*g) + 0.5*rho*CdA*v*v) * radius;

    function pickSmall(front){
      const maxSmall = Math.floor(front/ratioReq);
      const cand = stdSmall.filter(s=>s<=maxSmall);
      return cand.length? Math.max(...cand) : null;
    }
    function pickLarge(front){
      const rearNeeded = Math.ceil(front * Tw_req/(Tcrank*eff));
      const cand = stdLarge.filter(L=>L>=rearNeeded);
      return cand.length? Math.min(...cand) : null;
    }

    let report='';
    if(topFlatMph < targetTopMph){ report += `<div class="no">Flat power-limited top speed is ${fmt(mphToDisplay(topFlatMph),1)} ${unitLabel()}, below target ${fmt(mphToDisplay(targetTopMph),1)} ${unitLabel()}.</div>`; }
    const gPower = ((P_mech/v) - 0.5*rho*CdA*v*v)/(m*g) - Crr;
    if(gPower < targetGrade){ report += `<div class="no">Power-limited grade at ${fmt(mphToDisplay(climbMph),1)} ${unitLabel()} is ${(gPower*100).toFixed(1)}%, below target ${(targetGrade*100).toFixed(1)}%.</div>`; }
    if(!report) report = `<div class="ok">Targets look power-feasible. Now checking gearing‚Ä¶</div>`;

    let suggestion='';
    if(fixedWhat==='none'){
      let best=null;
      stdSmall.forEach(s=>{
        const ring = Math.ceil(ratioReq*s);
        const L = pickLarge(ring);
        if(L){ if(!best || ring<best.ring) best={ring,s,L}; }
      });
      suggestion = best
        ? `Suggested: <b>${best.ring}T</b> ring with cassette <b>${best.s}‚Äì${best.L}T</b>.`
        : `No standard combo (11‚Äì14T top, 26‚Äì50T low) meets both targets; raise rpm/power or relax targets.`;
    } else if(fixedWhat==='ring'){
      const s = pickSmall(fixedRing);
      const L = pickLarge(fixedRing);
      if(s && L) suggestion = `With a fixed <b>${fixedRing}T</b> ring, use cassette about <b>${s}‚Äì${L}T</b>.`;
      else if(!s && L) suggestion = `Top-speed target demands a smaller top cog than standard allows for a ${fixedRing}T ring. Increase ring size or rpm.`;
      else if(s && !L) suggestion = `Climb target needs a larger low cog (‚â•${Math.ceil(fixedRing*Tw_req/(Tcrank*eff))}T). Consider 40‚Äì50T low or a smaller ring.`;
      else suggestion = `Both targets conflict for a ${fixedRing}T ring. Raise rpm/power or adjust targets.`;
    } else {
      const frontMin = Math.ceil(ratioReq*fixedSmall);
      const frontMax = Math.floor( (fixedLarge*Tcrank*eff)/Tw_req );
      if(frontMin <= frontMax){
        suggestion = `With cassette <b>${fixedSmall}‚Äì${fixedLarge}T</b>, pick a ring around <b>${frontMin}T</b> (any in <b>${frontMin}‚Äì${frontMax}T</b> works).`;
      } else {
        suggestion = `With cassette <b>${fixedSmall}‚Äì${fixedLarge}T</b> there's no ring that hits both targets. Increase low cog to ‚â•<b>${Math.ceil(frontMin*Tw_req/(Tcrank*eff))}T</b> or raise rpm/power.`;
      }
    }

    $('#solveOut').innerHTML = report + `<div style="margin-top:6px">${suggestion}</div>`;
  }

  function rand(min,max){ return min + Math.random()*(max-min); }
  function percentile(arr,p){
    if(arr.length===0) return NaN;
    const a=arr.slice().sort((x,y)=>x-y);
    const idx=Math.min(a.length-1, Math.max(0, Math.floor((p/100)*(a.length-1))));
    return a[idx];
  }

  function runUncertainty(){
    const N = Math.max(10, parseInt($('#N').value,10)||300);
    const circ=getCirc(), radius=circ/(2*Math.PI);
    const front=parseInt($('#frontTeeth').value,10);
    const climbMph=getSpeedInputMph('climbMph'), v=climbMph*MPS_PER_MPH;
    const targetTopMph=getSpeedInputMph('targetTopMph'), targetGrade=parseFloat($('#targetGradePct').value)/100;
    const fixedWhat=$('#fixedWhat').value;
    const fixedRing=parseInt($('#fixedRing').value,10);
    const fixedSmall=parseInt($('#fixedSmall').value,10);
    const fixedLarge=parseInt($('#fixedLarge').value,10);
    const mode=$('#powerMode').value;
    const chainEff=parseFloat($('#driveEff').value);

    const mMin=parseFloat($('#u_mass_min').value), mMax=parseFloat($('#u_mass_max').value);
    const rpmMin=parseFloat($('#u_rpm_min').value), rpmMax=parseFloat($('#u_rpm_max').value);
    const Vmin=parseFloat($('#u_V_min').value), Vmax=parseFloat($('#u_V_max').value);
    const Amin=parseFloat($('#u_A_min').value), Amax=parseFloat($('#u_A_max').value);
    const effMin=parseFloat($('#u_eff_min').value), effMax=parseFloat($('#u_eff_max').value);
    const TMin=parseFloat($('#u_T_min').value), TMax=parseFloat($('#u_T_max').value);
    const RWmin=parseFloat($('#u_RW_min').value), RWmax=parseFloat($('#u_RW_max').value);
    const mechW_base=parseFloat($('#mechW').value);

    let feasible=0, powerTopFails=0, powerClimbFails=0, gearTopFails=0, gearClimbFails=0;
    const reqRingList=[], reqSmallList=[], reqLargeList=[];

    for(let i=0;i<N;i++){
      const m=rand(mMin,mMax), Crr=rand(0.005,0.008), CdA=rand(0.55,0.70), rho=1.20;
      const RW=rand(RWmin,RWmax);
      const rpm=rand(rpmMin,rpmMax);
      const V=mode==='va'?rand(Vmin,Vmax):parseFloat($('#voltage').value);
      const A=mode==='va'?rand(Amin,Amax):parseFloat($('#current').value);
      const eff=mode==='va'?rand(effMin,effMax):parseFloat($('#motorEff').value);
      const Tcrank=rand(TMin,TMax);
      const P_mech = (mode==='va' ? (V*A*eff) : mechW_base) + RW;

      const vFlat = binSearchTopSpeedFlat(P_mech, m, Crr, rho, CdA);
      const topFlatMph = vFlat*MPH_PER_MPS;
      const needTopMps = targetTopMph * MPS_PER_MPH;
      const ratioReq = needTopMps*60/(rpm*circ);
      const Tw_req = (((targetGrade + Crr)*m*g) + 0.5*rho*CdA*v*v) * radius;

      let powerOK = (topFlatMph >= targetTopMph) && ((((P_mech/v) - 0.5*rho*CdA*v*v)/(m*g) - Crr) >= targetGrade);
      if(!powerOK){
        if(topFlatMph < targetTopMph) powerTopFails++; else powerClimbFails++;
      }

      let gearOK=false, needRing=null, needSmall=null, needLarge=null;
      function needLargeFor(frontTeeth){ return Math.ceil(frontTeeth * Tw_req/(Tcrank*chainEff)); }

      if(fixedWhat==='none'){
        let best=null;
        stdSmall.forEach(s=>{
          const ring = Math.ceil(ratioReq*s);
          const Lneed = needLargeFor(ring);
          const L = stdLarge.find(x=>x>=Lneed);
          if(L){ const cand={ring,s,L}; if(!best || ring<best.ring) best=cand; }
        });
        if(best){ gearOK=true; needRing=best.ring; needSmall=best.s; needLarge=best.L; }
      } else if(fixedWhat==='ring'){
        const maxSmall = Math.floor(fixedRing/ratioReq);
        const s = stdSmall.filter(x=>x<=maxSmall).slice(-1)[0];
        const Lneed = needLargeFor(fixedRing);
        const L = stdLarge.find(x=>x>=Lneed);
        if(s && L){ gearOK=true; needRing=fixedRing; needSmall=s; needLarge=L; }
      } else {
        const ringMin = Math.ceil(ratioReq*fixedSmall);
        const ringMax = Math.floor( (fixedLarge*chainEff)/ (Tw_req/ (Tcrank)) );
        if(ringMin<=ringMax){ gearOK=true; needRing=ringMin; needSmall=fixedSmall; needLarge=fixedLarge; }
      }

      if(!gearOK){ if(topFlatMph >= targetTopMph) gearTopFails++; else gearClimbFails++; }

      if(powerOK && gearOK){
        feasible++;
        reqRingList.push(needRing);
        reqSmallList.push(needSmall);
        reqLargeList.push(needLarge);
      }
    }

    const cov = feasible/N*100;
    const ringP95 = Math.ceil(percentile(reqRingList,95));
    const ringP100 = Math.ceil(percentile(reqRingList,100));
    const smallMax = reqSmallList.length? Math.max(...reqSmallList) : NaN;
    const largeP95 = percentile(reqLargeList,95);
    const largeP100 = percentile(reqLargeList,100);

    let txt = `<div><span class="badge">Coverage</span> ${fmt(cov,1)}% of ${N} scenarios meet both power & gearing with your constraints.</div>`;
    if(N-feasible>0){
      txt += `<div style="margin-top:4px"><span class="badge">Why failures?</span> power(flat top) ${powerTopFails}, power(climb) ${powerClimbFails}, gearing limits ${gearTopFails+gearClimbFails}.</div>`;
    }

    if(reqRingList.length>0){
      txt += `<div style="margin-top:6px"><span class="badge">95% design</span> choose ring ‚âà <b>${ringP95}T</b>, top cog ‚â§ <b>${(isNaN(smallMax)?'‚Äî':smallMax+'T')}</b>, low cog ‚â• <b>${largeP95}T</b>.</div>`;
      txt += `<div style="margin-top:4px"><span class="badge">100% design</span> ring ‚âà <b>${ringP100}T</b>, top cog ‚â§ <b>${(isNaN(smallMax)?'‚Äî':smallMax+'T')}</b>, low cog ‚â• <b>${largeP100}T</b>.</div>`;
      txt += `<div class="note" style="margin-top:4px">Pick the nearest real parts: small from [11,12,13,14] and low from [26,28,30,32,34,36,40,42,46,50].</div>`;
    }else{
      txt += `<div class="no" style="margin-top:6px">No scenario satisfied both power and gearing with the current constraints. Consider raising rpm/power or relaxing targets.</div>`;
    }

    $('#uncOut').innerHTML = txt;
  }

  /* ---------- UI glue, events, presets, share, csv ---------- */
  function highlightSelectedRow(){
    $$('#resultTable tbody tr').forEach(tr=>tr.classList.remove('sel'));
    const tr = $(`#resultTable tbody tr:nth-child(${gearIndex+1})`);
    if(tr) tr.classList.add('sel');
  }
  function updateModeUI(){
    const va = $('#powerMode').value==='va';
    $('#voltage').disabled = !va;
    $('#current').disabled = !va;
    $('#mechW').disabled   =  va ? true : false;
  }
  function loadPresetNames(){
    const sel = $('#loadPreset');
    const store = JSON.parse(localStorage.getItem('mdp_presets')||'{}');
    const cur = sel.value;
    sel.innerHTML = `<option value="">Load preset‚Ä¶</option>` + Object.keys(store).sort().map(n=>`<option value="${n}">${n}</option>`).join('');
    if(cur && store[cur]) sel.value = cur;
  }
  function getConfigObject(){
    const obj={};
    $$('input,select').forEach(el=>{
      if(el.id) obj[el.id] = (el.type==='checkbox') ? el.checked : el.value;
    });
    obj.__speedUnit = speedUnit;
    obj.__fxEnabled = fxEnabled;
    return obj;
  }
  function applyConfigObject(obj){
    Object.entries(obj||{}).forEach(([k,v])=>{
      const el = $('#'+k);
      if(!el) return;
      if(el.type==='checkbox') el.checked = !!v; else el.value = v;
    });
    if(obj && obj.__speedUnit){ speedUnit = (obj.__speedUnit==='kph'?'kph':'mph'); setUnitButtons(); setSpeedLabels(); }
    if(obj && typeof obj.__fxEnabled==='boolean'){ setFX(obj.__fxEnabled); }
    compute();
  }
  function setUnitButtons(){
    $('#u_mph').classList.toggle('active', speedUnit==='mph');
    $('#u_kph').classList.toggle('active', speedUnit==='kph');
    $('#u_mph').setAttribute('aria-selected', speedUnit==='mph');
    $('#u_kph').setAttribute('aria-selected', speedUnit==='kph');
  }
  function setFX(on){
    fxEnabled = !!on;
    $('#fx_on').classList.toggle('active', fxEnabled);
    $('#fx_off').classList.toggle('active', !fxEnabled);
    $('#fx_on').setAttribute('aria-selected', fxEnabled);
    $('#fx_off').setAttribute('aria-selected', !fxEnabled);
    if(!fxEnabled) setPlay(true); // pause animation if FX off
  }
  function setPlay(paused){
    animRunning = !paused;
    $('#fx_play').textContent = paused ? 'Play' : 'Pause';
    if(animRunning) startAnim(); else stopAnim();
  }

  const autoCompute = debounce(()=>compute(), 200);
  $$( 'input,select').forEach(el=>{
    el.addEventListener('input', autoCompute, {passive:true});
    el.addEventListener('change', autoCompute);
  });

  $('#computeBtn').addEventListener('click', compute);
  $('#resetBtn').addEventListener('click', ()=>{ resetDefaults(); compute(); });
  $$('.pill[data-rear]').forEach(btn=> btn.addEventListener('click', ()=>{ $('#rearCogs').value=btn.getAttribute('data-rear'); compute(); }));
  $('#preset_power').addEventListener('click', ()=>{ $('#powerMode').value='va'; $('#voltage').value=52; $('#current').value=30; $('#motorEff').value=0.82; updateModeUI(); compute(); });
  $('#preset_rpm').addEventListener('click', ()=>{ $('#maxCadence').value=150; compute(); });
  $('#solveBtn').addEventListener('click', solve);
  $('#uncBtn').addEventListener('click', runUncertainty);
  $('#powerMode').addEventListener('change', ()=>{ updateModeUI(); compute(); });

  // Unit toggle
  $('#u_mph').addEventListener('click', ()=>{
    if(speedUnit==='mph') return;
    ['climbMph','rangeMph','targetTopMph'].forEach(id=>{
      const v = parseFloat($('#'+id).value)||0; $('#'+id).value = (v/1.609344).toFixed(2);
    });
    speedUnit='mph'; setUnitButtons(); setSpeedLabels(); compute();
  });
  $('#u_kph').addEventListener('click', ()=>{
    if(speedUnit==='kph') return;
    ['climbMph','rangeMph','targetTopMph'].forEach(id=>{
      const v = parseFloat($('#'+id).value)||0; $('#'+id).value = (v*1.609344).toFixed(2);
    });
    speedUnit='kph'; setUnitButtons(); setSpeedLabels(); compute();
  });

  // FX toggle + Play/Pause
  $('#fx_on').addEventListener('click', ()=> setFX(true));
  $('#fx_off').addEventListener('click', ()=> setFX(false));
  $('#fx_play').addEventListener('click', ()=> setPlay(animRunning));

  // Arrow keys gear shift (ignore when typing)
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='ArrowUp' && e.key!=='ArrowDown') return;
    const ae = document.activeElement;
    if(ae && (ae.tagName==='INPUT' || ae.TAGNAME==='TEXTAREA' || ae.tagName==='SELECT' || ae.isContentEditable)) return;
    const rears=parseRear($('#rearCogs').value);
    if(e.key==='ArrowUp'){ gearIndex++; gearIndex=clampGear(gearIndex,rears); compute(); e.preventDefault(); }
    if(e.key==='ArrowDown'){ gearIndex--; gearIndex=clampGear(gearIndex,rears); compute(); e.preventDefault(); }
  });
  $('#gearUp').addEventListener('click', ()=>{ gearIndex++; compute(); });
  $('#gearDown').addEventListener('click', ()=>{ gearIndex--; compute(); });

  // Visualizer RPM controls
  $('#visRpm').addEventListener('input', ()=>{ $('#visRpmNum').value = $('#visRpm').value; updateGearVisualizer(parseRear($('#rearCogs').value)); });
  $('#visRpmNum').addEventListener('input', ()=>{ let v=parseFloat($('#visRpmNum').value)||0; v=Math.max(0,Math.min(300,v)); $('#visRpm').value=v; updateGearVisualizer(parseRear($('#rearCogs').value)); });

  // Wheel preset convenience
  $('#wheelPreset').addEventListener('change', ()=>{
    const isCustom = $('#wheelPreset').value==='custom';
    $('#circumference').disabled = !isCustom;
  });
  $('#circumference').disabled = $('#wheelPreset').value!=='custom';

  // Click-to-select gear row
  $('#resultTable').addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-gi]'); if(!tr) return;
    const i = parseInt(tr.getAttribute('data-gi'),10);
    if(Number.isFinite(i)){ gearIndex=i; compute(); }
  });

  // Presets
  $('#savePreset').addEventListener('click', ()=>{
    const name = ($('#presetName').value||'').trim();
    if(!name){ alert('Name the preset first.'); return; }
    const store = JSON.parse(localStorage.getItem('mdp_presets')||'{}');
    store[name] = getConfigObject();
    localStorage.setItem('mdp_presets', JSON.stringify(store));
    loadPresetNames();
  });
  $('#loadPreset').addEventListener('change', ()=>{
    const name = $('#loadPreset').value; if(!name) return;
    const store = JSON.parse(localStorage.getItem('mdp_presets')||'{}');
    if(store[name]) applyConfigObject(store[name]);
  });
  $('#deletePreset').addEventListener('click', ()=>{
    const name = $('#loadPreset').value || ($('#presetName').value||'').trim();
    if(!name){ alert('Pick a preset to delete.'); return; }
    const store = JSON.parse(localStorage.getItem('mdp_presets')||'{}');
    if(store[name]){ delete store[name]; localStorage.setItem('mdp_presets', JSON.stringify(store)); loadPresetNames(); }
  });
  loadPresetNames();

  // Share URL
  $('#shareBtn').addEventListener('click', ()=>{
    const obj = getConfigObject();
    try{
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
      const url = `${location.origin}${location.pathname}#cfg=${b64}`;
      navigator.clipboard?.writeText(url);
      $('#shareMsg').textContent = 'Link copied';
      setTimeout(()=>$('#shareMsg').textContent='', 1500);
      history.replaceState(null,'',url);
    }catch(e){
      $('#shareMsg').textContent = 'Share failed';
      setTimeout(()=>$('#shareMsg').textContent='', 1500);
    }
  });
  (function tryImportFromHash(){
    const h = location.hash||'';
    const m = h.match(/#cfg=([^&]+)/);
    if(m){
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(m[1]))));
        applyConfigObject(obj);
      }catch(e){ /* ignore */ }
    }
  })();

  // CSV export
  $('#exportCsv').addEventListener('click', ()=>{
    const rows = [['Gear','Ratio','Top speed ('+unitLabel()+')','Wheel torque (Nm)','Max grade (torque @v)','Max grade (actual @v)']];
    $$('#resultTable tbody tr').forEach(tr=>{
      const cols=Array.from(tr.children).map(td=>td.textContent);
      rows.push(cols);
    });
    const csv = rows.map(r=>r.map(x=>{
      const s=String(x); return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'per-gear-results.csv';
    document.body.appendChild(a); a.click(); a.remove();
  });

  // Resize re-draw
  window.addEventListener('resize', ()=>{ clearTimeout(window.__rz); window.__rz=setTimeout(()=>{ drawGearCanvas(parseRear($('#rearCogs').value)); compute(); },120); }, {passive:true});
  if('ResizeObserver' in window){
    const ro = new ResizeObserver(()=>{ drawGearCanvas(parseRear($('#rearCogs').value)); compute(); });
    ['chartSlope','chartSpeed','chartTorque','chartGrade','gearCanvas'].forEach(id=>{
      const el = document.getElementById(id); if(el) ro.observe(el);
    });
  }

  /* ---------- Animation loop ---------- */
  function tick(ts){
    if(!animRunning){ return; }
    if(!lastT) lastT = ts;
    const dt = Math.min(0.05, (ts - lastT)/1000);
    lastT = ts;

    const rears = parseRear($('#rearCogs').value);
    if(!rears.length){ animRunning=false; return; }

    const frontT = parseInt($('#frontTeeth').value,10)||40;
    const rearT  = rears[gearIndex];
    const visRpm = Math.max(0, parseFloat($('#visRpmNum').value)||1);
    const ratio  = frontT/rearT;

    const wFront = 2*Math.PI*(visRpm/60);
    const wRear  = 2*Math.PI*(visRpm*ratio/60);
    const wWheel = wRear;

    angFront += wFront*dt;
    angRear  += wRear*dt;
    angWheel += wWheel*dt;

    const rFront = Math.max(20, Math.sqrt(frontT)*2.4);
    const chainSpeedPxPerSec = (2*Math.PI*rFront) * (visRpm/60);
    chainOffset += chainSpeedPxPerSec*dt;

    drawGearCanvas(rears);
    animId = requestAnimationFrame(tick);
  }
  function startAnim(){
    if(!fxEnabled) return;
    if(animId) cancelAnimationFrame(animId);
    lastT = 0; animId = requestAnimationFrame(tick);
  }
  function stopAnim(){
    if(animId){ cancelAnimationFrame(animId); animId = null; }
  }

  // public controls
  function resetDefaults(){
    $('#wheelPreset').value='2100'; $('#circumference').value='';
    $('#frontTeeth').value=40; $('#rearCogs').value='13,14,16,18,21,24,28,34';
    $('#mass').value=160;
    $('#riderW').value=0; setSpeedInputDisplayFromMph('climbMph',3);
    $('#powerMode').value='va';
    $('#voltage').value=52; $('#current').value=30; $('#motorEff').value=0.82; $('#mechW').value=1280;
    $('#crankTorque').value=160; $('#driveEff').value=0.95; $('#maxCadence').value=140;
    $('#batAh').value=20; $('#usablePct').value=85; setSpeedInputDisplayFromMph('rangeMph',20); $('#rangeGradePct').value=10;
    $('#visRpm').value=1; $('#visRpmNum').value=1;
    setSpeedInputDisplayFromMph('targetTopMph',29);
    gearIndex = 0; firstCompute = true;
    updateModeUI();
  }

  /* ---------- Tooltips: desktop hover + mobile tap ---------- */
  let tipSeq = 0;
  function mkTipButton(title, body, below=false){
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='help-icon' + (below?' tip-below':'');
    btn.setAttribute('aria-label','Help');
    const id = `tip_${++tipSeq}`;
    btn.setAttribute('aria-expanded','false');
    btn.setAttribute('aria-controls', id);
    btn.innerHTML = '?';
    const bubble = document.createElement('div');
    bubble.className='tip-bubble';
    bubble.id = id;
    bubble.setAttribute('role','tooltip');
    bubble.innerHTML = (title? `<span class="tip-title">${title}</span>`:'') + body;
    btn.appendChild(bubble);
    // interactions
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const open = btn.classList.toggle('open');
      btn.setAttribute('aria-expanded', open?'true':'false');
      if(open) closeOtherTips(btn);
      clampTipToViewport(bubble);
    });
    btn.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ btn.classList.remove('open'); btn.setAttribute('aria-expanded','false'); btn.blur(); }
    });
    return btn;
  }
  function closeOtherTips(except){
    $$('.help-icon.open').forEach(b=>{ if(b!==except){ b.classList.remove('open'); b.setAttribute('aria-expanded','false'); } });
  }
  document.addEventListener('click', ()=> closeOtherTips(null), {passive:true});
  window.addEventListener('scroll', ()=> closeOtherTips(null), {passive:true});

  function clampTipToViewport(bubble){
    const rect = bubble.getBoundingClientRect();
    const pad = 8;
    let dx = 0;
    if(rect.left < pad) dx = pad - rect.left;
    else if(rect.right > window.innerWidth - pad) dx = (window.innerWidth - pad) - rect.right;
    if(dx!==0){
      bubble.style.transform = `translateX(calc(-50% + ${dx}px))`;
    }else{
      bubble.style.transform = '';
    }
  }

  function addTipAfterLabel(forId, title, body, below=false){
    const label = document.querySelector(`label[for="${forId}"]`);
    if(!label) return;
    const tip = mkTipButton(title, body, below);
    label.appendChild(tip); // inline with label text
  }
  function addTipAfterSectionTitle(matchText, title, body, below=true){
    const nodes = $$('.section-title');
    for(const n of nodes){
      if(n.textContent.trim().toLowerCase().includes(matchText.toLowerCase())){
        const tip = mkTipButton(title, body, below);
        n.appendChild(tip);
        break;
      }
    }
  }

  // Add lots of tooltips
  function injectHelp(){
    addTipAfterLabel('wheelPreset','Wheel size preset',
      'Choose a typical wheel. ‚ÄúUse custom circumference‚Äù lets you enter a measured tyre rollout in millimetres (mm). Speed scales linearly with circumference.');
    addTipAfterLabel('circumference','Custom circumference',
      'Roll the bike one wheel revolution and measure ground distance in mm. Leave blank to use the preset value.');
    addTipAfterLabel('frontTeeth','Front chainring teeth',
      'More teeth = higher top speed at the same cadence, but less torque at the wheel for climbing.');
    addTipAfterLabel('rearCogs','Rear cogs (CSV)',
      'Enter sprocket teeth separated by commas (e.g. 13,14,16,‚Ä¶). Values are cleaned, deduplicated and sorted.');

    addTipAfterLabel('mass','Total mass',
      'Rider + bike + cargo, in kilograms (kg). Affects rolling and gravitational loads.');
    addTipAfterLabel('riderW','Rider watts',
      'Average rider mechanical power that adds to the motor at the wheel.');
    addTipAfterLabel('climbMph','Climb speed',
      'The speed used when computing climb grades. Aerodynamic drag grows with v¬≥; slower climbs reduce aero load.');

    addTipAfterLabel('powerMode','Power entry mode',
      'Either compute mechanical power from battery V√óA√óefficiency, or enter shaft mechanical watts directly.');
    addTipAfterLabel('voltage','Battery voltage (V)',
      'Nominal pack voltage. Higher V generally allows more power at the same current.');
    addTipAfterLabel('current','Controller current (A)',
      'Controller battery current limit in amperes (A).');
    addTipAfterLabel('motorEff','Motor+controller efficiency',
      'Fraction (0‚Äì1) converting battery watts to shaft watts. Includes controller+motor losses.');
    addTipAfterLabel('mechW','Mechanical watts',
      'Direct mechanical power at the shaft (use when not in V√óA mode).');
    addTipAfterLabel('crankTorque','Crank torque (Nm)',
      'Available crank torque delivered to the chainring. Affects torque-limited climbs.');
    addTipAfterLabel('driveEff','Drivetrain efficiency',
      'Fraction (0‚Äì1) for chain, sprockets and bearings.');
    addTipAfterLabel('maxCadence','Max chainring rpm',
      'RPM limit at the chainring. Sets the rpm-limited top speed per gear.');

    addTipAfterLabel('batAh','Battery capacity (Ah)',
      'Ampere-hours. Multiply by voltage for watt-hours (Wh). The range calc uses usable Wh.');
    addTipAfterLabel('usablePct','Usable %',
      'Leave some reserve for battery longevity or safety. Range uses this percentage of pack energy.');
    addTipAfterLabel('rangeMph','Range cruise speed',
      'Speed used for range estimation. Includes grade and rider watts.');
    addTipAfterLabel('rangeGradePct','Range grade',
      'Climb grade to include in the range calculation (0% = flat).');

    addTipAfterSectionTitle('Gear visualizer',
      'Visualizer',
      'The animation ties to the chainring rpm slider. Use ‚ñ≤/‚ñº or the buttons to shift. On desktop, Arrow Up/Down also shift.', true);
    addTipAfterLabel('visRpm','Visualizer RPM',
      'Controls animation speed and the live wheel rpm/speed readout.', true);

    addTipAfterSectionTitle('Per-gear results','Per-gear table',
      'Top speed is rpm-limited for each gear; a flat power-limit line shows the aerodynamic+rolling limit independent of gearing.');

    addTipAfterSectionTitle('Reverse engineer','Reverse engineer',
      'Enter targets and constraints. The solver proposes chainring and cassette options that meet both top-speed and climb requirements.');

    addTipAfterSectionTitle('Uncertainty','Uncertainty sweeps',
      'Run a Monte Carlo sweep across ranges (mass, rpm, V/A/eff, torque, drag, rider watts). ‚ÄúCoverage‚Äù reports how many scenarios pass.', true);

    // Small help on gear controls
    const gearCtl = document.getElementById('gearControls');
    if(gearCtl){
      const tip = mkTipButton('Shifting',
        '‚ñ≤ shifts to a larger rear cog (easier), ‚ñº to a smaller one (harder). The selected row in the table highlights the current gear.', true);
      gearCtl.appendChild(tip);
    }
  }

  // Init sequence
  setSpeedLabels();
  setUnitButtons();
  $('#fx_play').textContent = animRunning ? 'Pause' : 'Play';
  resetDefaults();
  compute();
  if(animRunning) startAnim();

  // Restart animation when rpm or gear changes
  $('#visRpm,#visRpmNum').addEventListener('input', ()=>{ if(animRunning) startAnim(); }, {passive:true});
  $('#gearUp').addEventListener('click', ()=>{ if(animRunning) startAnim(); });
  $('#gearDown').addEventListener('click', ()=>{ if(animRunning) startAnim(); });

  // Inject tooltips once DOM is ready
  injectHelp();
})();
</script>
</body>
</html>